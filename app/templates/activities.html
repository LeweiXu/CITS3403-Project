{% extends "base.html" %}

{% block title %}MediaTracker - Past Activities{% endblock %}

{% block content %}
<div class="page-container">
    <h2 class="text-center page-title">Activities</h2>

    <!-- Filter Form -->
    <section class="section wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.05s">
    <form action="{{ url_for('activities') }}" method="GET" class="mb-4">
        <div class="row align-items-center">
            <div class="col-md-2">
                <label for="start_date" class="form-label">Start Date</label>
                <input type="date" id="start_date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
            </div>
            <div class="col-md-2">
                <label for="end_date" class="form-label">End Date</label>
                <input type="date" id="end_date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
            </div>
            <div class="col-md-2">
                <label for="media_name" class="form-label">Media Name</label>
                <input type="text" id="media_name" name="media_name" class="form-control" placeholder="e.g., Inception" value="{{ request.args.get('media_name', '') }}">
            </div>
            <div class="col-md-2">
                <label for="media_type" class="form-label">Media Type</label>
                <input type="text" id="media_type" name="media_type" class="form-control" placeholder="e.g., Movie" value="{{ request.args.get('media_type', '') }}">
            </div>
            <div class="col-md-2">
                <label for="min_duration" class="form-label">Min Duration</label>
                <input type="number" id="min_duration" name="min_duration" class="form-control" placeholder="e.g., 30" value="{{ request.args.get('min_duration', '') }}">
            </div>
            <div class="col-md-2">
                <label for="max_duration" class="form-label">Max Duration</label>
                <input type="number" id="max_duration" name="max_duration" class="form-control" placeholder="e.g., 120" value="{{ request.args.get('max_duration', '') }}">
            </div>
            <div class="row mt-3">
                <div class="col-md-12 text-center">
                    <button type="submit" class="btn btn-primary">Search</button>
                    <a href="{{ url_for('activities') }}" class="btn btn-secondary">Reset</a>
                </div>
            </div>
        </div>
    </form>
    </section>

    <!-- Activities Table -->
    <section class="table-section">
    <table class="table mt-4">
        <thead>
            <tr>
                <th class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.05s">Media Name</th>
                <th class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.2s">Total Duration (minutes)</th>
                <th class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.25s">Start Date</th>
                <th class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.3s">End Date</th>
            </tr>
        </thead>
        <tbody>
            <!-- Uncompleted Activities -->
            {% for activity in uncompleted_activities %}
            <tr class="activity-row">
                <td class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.05s">{{ activity.media_name }}</td>
                <td class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.2s">{{ activity.total_duration }}</td>
                <td class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.3s">{{ activity.start_date }}</td>
                <td class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.4s">Ongoing</td>
            </tr>
            <tr class="activity-details">
                <td>
                    Media Type: {{ activity.media_type }}<br>
                    Sub-Type: {{ activity.media_subtype }}
                </td>
                <td>
                    Rating: N/A<br>
                    Comment: N/A
                </td>
                {% if current_user.username == username %}
                <td>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#endActivityModal" data-activity-id="{{ activity.id }}">End Activity</button>
                </td>
                <td>
                    <a href="{{ url_for('delete_activity', activity_id=activity.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this activity?');">Delete Activity</a>
                </td>
                {% endif %}
            </tr>
            {% endfor %}

            <!-- Completed Activities -->
            {% for activity in completed_activities %}
            <tr class="activity-row">
                <td class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.05s">{{ activity.media_name }}</td>
                <td class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.2s">{{ activity.total_duration }}</td>
                <td class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.3s">{{ activity.start_date }}</td>
                <td class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.4s">{{ activity.end_date }}</td>
            </tr>
            <tr class="activity-details">
                <td>
                    Media Type: {{ activity.media_type }}<br>
                    Sub-Type: {{ activity.media_subtype }}
                </td>
                <td>
                    Rating: {{ activity.rating }}<br>
                    Comment: {{ activity.comment }}
                </td>
                    {% if current_user.username == username %}
                    <td>
                        <form method="POST" action="{{ url_for('reopen_activity') }}" style="display:inline;">
                            <input type="hidden" name="activity_id" value="{{ activity.id }}">
                            <button type="submit" class="btn btn-success btn-sm">Re-open</button>
                        </form>
                    </td>
                    <td>
                        <form method="POST" action="{{ url_for('delete_activity') }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this activity?');">
                            <input type="hidden" name="activity_id" value="{{ activity.id }}">
                            <button type="submit" class="btn btn-danger btn-sm">Delete Activity</button>
                        </form>
                    </td>
                    {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if total_pages > 1 %}
        <nav aria-label="Pagination">
        <ul class="pagination justify-content-center mt-4">
            {% if page > 1 %}
            <li class="page-item">
                <a class="page-link"
                href="{{ url_for(request.endpoint, page=page-1, **request_args) }}">
                &laquo; Prev
                </a>
            </li>
            {% endif %}
            {% for p in range(1, total_pages+1) %}
            <li class="page-item {% if p==page %}active{% endif %}">
                <a class="page-link"
                href="{{ url_for(request.endpoint, page=p, **request_args) }}">
                {{ p }}
                </a>
            </li>
            {% endfor %}
            {% if page < total_pages %}
            <li class="page-item">
                <a class="page-link"
                href="{{ url_for(request.endpoint, page=page+1, **request_args) }}">
                Next &raquo;
                </a>
            </li>
            {% endif %}
        </ul>
        </nav>
        {% endif %}
    </section>

    <!-- End Activity Modal -->
    <div class="modal" id="endActivityModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="endActivityForm" action="{{ url_for('end_activity') }}" method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title">End Activity</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="modal-activity-id" name="activity_id" value="">
                        <div class="mb-3">
                            <label for="rating" class="form-label">Rating (1.0-10.0)</label>
                            <input type="number" id="rating" name="rating" class="form-control" min="1.0" max="10.0" step="0.1" placeholder="Optional">
                        </div>
                        <div class="mb-3">
                            <label for="comment" class="form-label">Comment</label>
                            <textarea id="comment" name="comment" class="form-control" placeholder="Optional"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" id="submitButton">Submit</button>
                        <button type="button" class="btn btn-secondary" id="skipButton" data-bs-dismiss="modal">Skip</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Ensure all additional activity details are hidden by default
        document.querySelectorAll('.activity-details').forEach(detailsRow => {
            detailsRow.style.display = 'none';
        });

        // Toggle visibility of the additional details when an activity row is clicked
        document.querySelectorAll('.activity-row').forEach(row => {
            row.addEventListener('click', () => {
                const detailsRow = row.nextElementSibling;
                if (detailsRow && detailsRow.classList.contains('activity-details')) {
                    detailsRow.style.display = detailsRow.style.display === 'table-row' ? 'none' : 'table-row';
                }
            });
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const endActivityButtons = document.querySelectorAll('[data-bs-target="#endActivityModal"]');
        const activityIdInput = document.getElementById('modal-activity-id');
        const skipButton = document.getElementById('skipButton');
        const endActivityForm = document.getElementById('endActivityForm');

        // Set the activity ID when the modal is opened
        endActivityButtons.forEach(button => {
            button.addEventListener('click', () => {
                const activityId = button.getAttribute('data-activity-id');
                activityIdInput.value = activityId;
            });
        });

        // Handle the Skip button behavior
        skipButton.addEventListener('click', () => {
            // Clear the rating and comment fields before submitting
            document.getElementById('rating').value = '';
            document.getElementById('comment').value = '';
            endActivityForm.submit();
        });

        const mediaTypeSelect = document.getElementById('media_type');
        const mediaSubtypeSelect = document.getElementById('media_subtype');

        const mediaTypes = {
            "Visual Media": ["None", "Movie", "TV Show", "Documentary", "Anime", "Short Film", "Theater Play"],
            "Audio Media": ["None", "Podcast", "Music", "Audiobook"],
            "Text Media": ["None", "Book", "Article", "Blog", "News", "Comic", "Manga", "Webtoon", "Graphic Novel", "Light Novel", "Novel", "Short Story", "Web Novel"],
            "Interactive Media": ["None", "First Person Shooter", "Role Playing Game", "Simulation", "Puzzle", "Platformer", "Strategy", "Adventure"]
        };

        mediaTypeSelect.addEventListener('change', () => {
            const selectedType = mediaTypeSelect.value;
            mediaSubtypeSelect.innerHTML = '';

            if (selectedType) {
                mediaSubtypeSelect.disabled = false;
                mediaTypes[selectedType].forEach(subtype => {
                    const option = document.createElement('option');
                    option.value = subtype;
                    option.textContent = subtype;
                    mediaSubtypeSelect.appendChild(option);
                });
            } else {
                mediaSubtypeSelect.disabled = true;
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'None';
                mediaSubtypeSelect.appendChild(defaultOption);
            }
        });
    });
</script>
{% endblock %}