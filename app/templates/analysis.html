{% extends "base.html" %}

{% block title %}MediaTracker - Analysis{% endblock %}

{% block content %}
<div class="container mt-4">
    <section id="analysis-section" class="wow fadeInUp" data-wow-delay=".1s">
        <h1 class="text-center">Analysis</h1>
        <div class="mt-4 row">
            <div class="col-md-4 wow fadeInUp" data-wow-delay=".2s">
                <div class="card a0 dark:a1 a2d p-3 shadow">
                    <h4>Total Time Spent</h4>
                    <p>Visual Media: <span id="total-visual-media">{{ analysis_data.statistics.total_visual_media }} hours</span></p>
                    <p>Audio Media: <span id="total-audio-media">{{ analysis_data.statistics.total_audio_media }} hours</span></p>
                    <p>Text Media: <span id="total-text-media">{{ analysis_data.statistics.total_text_media }} hours</span></p>
                    <p>Interactive Media: <span id="total-interactive-media">{{ analysis_data.statistics.total_interactive_media }} hours</span></p>
                </div>
            </div>
            <div class="col-md-4 wow fadeInUp" data-wow-delay=".3s">
                <div class="card a0 dark:a1 a2d p-3 shadow">
                    <h4>Time Spent in the Past Week</h4>
                    <p>Visual Media: <span id="week-visual-media">{{ analysis_data.statistics.week_visual_media }} hours</span></p>
                    <p>Audio Media: <span id="week-audio-media">{{ analysis_data.statistics.week_audio_media }} hours</span></p>
                    <p>Text Media: <span id="week-text-media">{{ analysis_data.statistics.week_text_media }} hours</span></p>
                    <p>Interactive Media: <span id="week-interactive-media">{{ analysis_data.statistics.week_interactive_media }} hours</span></p>
                </div>
            </div>
            <div class="col-md-4 wow fadeInUp" data-wow-delay=".4s">
                <div class="card a0 dark:a1 a2d p-3 shadow">
                    <h4>Longest Activity</h4>
                    <p>Media Name: <span id="longest-activity-name">{{ analysis_data.statistics.longest_activity.media_name }}</span></p>
                    <p>Duration: <span id="longest-activity-duration">{{ analysis_data.statistics.longest_activity.duration }} hours</span></p>
                </div>
            </div>
        </div>
    </section>

    <section id="rankings-section" class="mt-5 wow fadeInUp" data-wow-delay=".5s">
        <h2>Rankings</h2>
        <div class="mb-3">
            <label for="ranking-select" class="form-label">Select Ranking:</label>
            <select id="ranking-select" class="form-select">
                <option value="activities-duration">Activities by Duration</option>
                <option value="entries-duration">Entries by Duration</option>
                <option value="activities-start-date">Activities by Start Date</option>
                <option value="entries-media-subtype">Entries by Media Subtype</option>
            </select>
        </div>
        <div id="ranking-view" class="card a0 dark:a1 a2d p-3 shadow">
            <!-- 初始排名内容将由 JS 注入 -->
        </div>
    </section>

    <section id="graphs-section" class="mt-5 wow fadeInUp" data-wow-delay=".6s">
        <h2>Graphs</h2>
        <div class="mb-3">
            <label for="graph-select" class="form-label">Select Graph:</label>
            <select id="graph-select" class="form-select">
                <option value="daily-time">Total Time Spent Daily (Past Week)</option>
                <option value="weekly-average">Weekly Average Time (Past 10 Weeks)</option>
                <option value="daily-category">Daily Time by Category (Past Week)</option>
            </select>
        </div>
        <div id="graph-view" class="card a0 dark:a1 a2d p-3 shadow">
            <canvas id="graph-canvas" width="400" height="200"></canvas>
        </div>
    </section>
</div>

<!-- 隐藏的数据提供 JSON 格式 -->
<input type="hidden" id="analysis-data" value='{{ analysis_data|tojson }}'>

<!-- 样式与动画资源 -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/animate.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/analysis.css') }}">
<script src="{{ url_for('static', filename='js/wow.min.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    new WOW().init();

    document.addEventListener('DOMContentLoaded', () => {
        const rankingSelect = document.getElementById('ranking-select');
        const rankingView = document.getElementById('ranking-view');
        const analysisData = JSON.parse(document.getElementById('analysis-data').value || '{}');

        function renderRanking(type) {
            let html = "";
            if (type === 'activities-duration') {
                html += `<h4>Activities Ranked by Duration</h4><table class="table"><thead><tr><th>Media Name</th><th>Type</th><th>Duration</th><th>Start Date</th><th>End Date</th></tr></thead><tbody>`;
                analysisData.rankings.activities_by_duration.forEach(a => {
                    html += `<tr><td>${a.media_name}</td><td>${a.media_type}</td><td>${a.total_duration}</td><td>${a.start_date}</td><td>${a.end_date}</td></tr>`;
                });
                html += `</tbody></table>`;
            } else if (type === 'entries-duration') {
                html += `<h4>Entries Ranked by Duration</h4><table class="table"><thead><tr><th>Media Name</th><th>Type</th><th>Duration</th></tr></thead><tbody>`;
                analysisData.rankings.entries_by_duration.forEach(e => {
                    html += `<tr><td>${e.media_name}</td><td>${e.media_type}</td><td>${e.duration}</td></tr>`;
                });
                html += `</tbody></table>`;
            } else if (type === 'activities-start-date') {
                html += `<h4>Activities Ranked by Start Date</h4><table class="table"><thead><tr><th>Media Name</th><th>Type</th><th>Start Date</th><th>Duration</th></tr></thead><tbody>`;
                analysisData.rankings.activities_by_start_date.forEach(a => {
                    html += `<tr><td>${a.media_name}</td><td>${a.media_type}</td><td>${a.start_date}</td><td>${a.total_duration}</td></tr>`;
                });
                html += `</tbody></table>`;
            } else if (type === 'entries-media-subtype') {
                html += `<h4>Entries Ranked by Media Subtype</h4><table class="table"><thead><tr><th>Media Subtype</th><th>Total Duration</th></tr></thead><tbody>`;
                analysisData.rankings.entries_by_media_subtype.forEach(e => {
                    html += `<tr><td>${e.media_subtype}</td><td>${e.total_duration}</td></tr>`;
                });
                html += `</tbody></table>`;
            }
            rankingView.innerHTML = html;
        }

        rankingSelect.addEventListener('change', () => {
            renderRanking(rankingSelect.value);
        });
        renderRanking(rankingSelect.value); // 初始化调用

        // 图表绘制逻辑
        const graphSelect = document.getElementById('graph-select');
        const ctx = document.getElementById('graph-canvas').getContext('2d');
        let currentChart = null;

        function drawGraph(type) {
            if (currentChart) currentChart.destroy();

            if (type === 'daily-time') {
                const data = analysisData.graphs.daily_time_past_week;
                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [{
                            label: 'Total Time (Hours)',
                            data: data.map(d => d.total_duration / 60),
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            } else if (type === 'weekly-average') {
                const data = analysisData.graphs.weekly_average_past_10_weeks;
                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.week),
                        datasets: [{
                            label: 'Weekly Avg Time (Hours)',
                            data: data.map(d => d.average_duration / 60),
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            } else if (type === 'daily-category') {
                const data = analysisData.graphs.daily_category_past_week;
                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [
                            {
                                label: 'Visual',
                                data: data.map(d => d.visual_media / 60),
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderWidth: 1
                            },
                            {
                                label: 'Audio',
                                data: data.map(d => d.audio_media / 60),
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderWidth: 1
                            },
                            {
                                label: 'Text',
                                data: data.map(d => d.text_media / 60),
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderWidth: 1
                            },
                            {
                                label: 'Interactive',
                                data: data.map(d => d.interactive_media / 60),
                                borderColor: 'rgba(153, 102, 255, 1)',
                                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            }
        }

        graphSelect.addEventListener('change', () => {
            drawGraph(graphSelect.value);
        });
        drawGraph(graphSelect.value); // 初始化调用
    });
</script>
{% endblock %}
