{% extends "base.html" %}

{% block title %}MediaTracker - Dashboard{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center section-title">Dashboard</h1>
    <!-- Stats Overview Section -->
    <section class="stats-overview">
        <h2 class="section-title">Key Stats</h2>
        <div class="stats-grid">
            <!-- Total time spent on media -->
            <div class="stats-metric-card">
                <div class="stats-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stats-info">
                    <h3>Total Time Spent</h3>
                    <p class="stats-value">{{ total_time }} hours</p>
                </div>
            </div>

            <!-- Most Consumed Media -->
            <div class="stats-metric-card">
                <div class="stats-icon">
                    <i class="fas fa-film"></i>
                </div>
                <div class="stats-info">
                    <h3>Most Consumed Media</h3>
                    <p class="stats-value">{{ most_consumed_media }}</p>
                </div>
            </div>

            <!-- Average Daily Media Consumption -->
            <div class="stats-metric-card">
                <div class="stats-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stats-info">
                    <h3>Average Daily Consumption</h3>
                    <p class="stats-value">{{ daily_average_time }} hours</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Current Media Section -->
    <section class="current-media mt-5">
        <h2 class="section-title">Current Activities</h2>
        <table class="table table-striped mt-4">
            <thead>
                <tr>
                    <th>Media Name</th>
                    <th>Total Duration (minutes)</th>
                    <th>Add Duration</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for activity in current_activities %}
                <tr>
                    <td>{{ activity.media_name }}</td>
                    <td>{{ activity.total_duration }}</td>
                    <td>
                        <form action="{{ url_for('dashboard') }}" method="POST" class="d-inline">
                            <input type="hidden" name="media_name" value="{{ activity.media_name }}">
                            <input type="hidden" name="media_type" value="{{ activity.media_type }}">
                            <input type="number" name="duration" class="form-control d-inline w-50" placeholder="Minutes" required>
                            <button type="submit" name="add_duration" class="btn btn-success btn-sm">Add</button>
                        </form>
                    </td>
                    <td>
                        <!-- End Activity Button -->
                        <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#endActivityModal" data-activity-id="{{ activity.activity_id }}">End Activity</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

    <!-- End Activity Modal -->
    <div class="modal" id="endActivityModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="endActivityForm" action="{{ url_for('end_activity') }}" method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title">End Activity</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="modal-activity-id" name="activity_id" value="">
                        <div class="mb-3">
                            <label for="rating" class="form-label">Rating (1.0-10.0)</label>
                            <input type="number" id="rating" name="rating" class="form-control" min="1.0" max="10.0" step="0.1" placeholder="Optional">
                        </div>
                        <div class="mb-3">
                            <label for="comment" class="form-label">Comment</label>
                            <textarea id="comment" name="comment" class="form-control" placeholder="Optional"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" id="submitButton">Submit</button>
                        <button type="button" class="btn btn-secondary" id="skipButton" data-bs-dismiss="modal">Skip</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add New Media Entry Section -->
    <section class="add-new-entry mt-5">
        <h2 class="section-title">Add New</h2>
        <form action="{{ url_for('dashboard') }}" method="POST">
            <div class="mb-3">
                <label for="media_type" class="form-label">Media Type</label>
                <input type="text" id="media_type" name="media_type" class="form-control" placeholder="e.g., Movie, Book" required>
            </div>
            <div class="mb-3">
                <label for="media_name" class="form-label">Media Name</label>
                <input type="text" id="media_name" name="media_name" class="form-control" placeholder="e.g., Inception, 1984" required>
            </div>
            <div class="mb-3">
                <label for="duration" class="form-label">Duration (minutes)</label>
                <input type="number" id="duration" name="duration" class="form-control" placeholder="e.g., 120" required>
            </div>
            <button type="submit" name="add_new_entry" class="btn btn-primary">Add New Activity</button>
        </form>
    </section>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const endActivityButtons = document.querySelectorAll('[data-bs-target="#endActivityModal"]');
        const activityIdInput = document.getElementById('modal-activity-id');
        const skipButton = document.getElementById('skipButton');
        const endActivityForm = document.getElementById('endActivityForm');

        // Set the activity ID when the modal is opened
        endActivityButtons.forEach(button => {
            button.addEventListener('click', () => {
                const activityId = button.getAttribute('data-activity-id');
                activityIdInput.value = activityId;
            });
        });

        // Handle the Skip button behavior
        skipButton.addEventListener('click', () => {
            // Clear the rating and comment fields before submitting
            document.getElementById('rating').value = '';
            document.getElementById('comment').value = '';
            endActivityForm.submit();
        });
    });
</script>
{% endblock %}