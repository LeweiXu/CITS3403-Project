{% extends "base.html" %}

{% block title %}MediaTracker - View Data{% endblock %}

{% block content %}
<div class="page-container">
    {% if current_user.username == username %}
        <h2 class="text-center page-title">Your Media Entries</h2>
    {% else %}
        <h2 class="text-center page-title">{{ username }}'s Media Entries</h2>
    {% endif %}
    <section class="section wow fadeIn" data-wow-duration="0.2s" data-wow-delay="0.05s">
        <!-- Search Bar -->
        <form action="{{ url_for('main.viewdata') }}" method="GET" class="mb-4">
            <div class="row">
                <div class="col-md-2">
                    <label for="start_date" class="form-label">Start Date</label>
                    <input type="date" id="start_date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
                </div>
                <div class="col-md-2">
                    <label for="end_date" class="form-label">End Date</label>
                    <input type="date" id="end_date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
                </div>
                <div class="col-md-2">
                    <label for="media_name" class="form-label">Media Name</label>
                    <input type="text" id="media_name" name="media_name" class="form-control" placeholder="e.g., Inception" value="{{ request.args.get('media_name', '') }}">
                </div>
                <div class="col-md-2">
                    <label for="media_type" class="form-label">Media Type</label>
                    <input type="text" id="media_type" name="media_type" class="form-control" placeholder="e.g., Movie" value="{{ request.args.get('media_type', '') }}">
                </div>
                <div class="col-md-2">
                    <label for="min_duration" class="form-label">Min Duration</label>
                    <input type="number" id="min_duration" name="min_duration" class="form-control" placeholder="e.g., 30" value="{{ request.args.get('min_duration', '') }}">
                </div>
                <div class="col-md-2">
                    <label for="max_duration" class="form-label">Max Duration</label>
                    <input type="number" id="max_duration" name="max_duration" class="form-control" placeholder="e.g., 120" value="{{ request.args.get('max_duration', '') }}">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12 text-center">
                    <button type="submit" class="btn btn-primary">Search</button>
                    <a href="{{ url_for('main.viewdata') }}" class="btn btn-secondary">Reset</a>
                </div>
            </div>
        </form>
    </section>  

    <section class="table-section wow fadeIn" data-wow-duration="0.2s" data-wow-delay="0.1">
        <table class="table">
            <thead>
                <tr>
                    <th class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.1s">Date</th>
                    <th class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.15s">Media Type</th>
                    <th class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.2s">Media Name</th>
                    <th class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.25s">Duration (minutes)</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr class="entry-row">
                    <td class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.1s">{{ entry.date }}</td>
                    <td class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.15s">{{ entry.activity.media_type }}</td>
                    <td class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.2s">{{ entry.activity.media_name }}</td>
                    <td class="wow fadeInUp" data-wow-duration="0.2s" data-wow-delay="0.25s">{{ entry.duration }}</td>
                </tr>
                <tr class="entry-comment">
                    <td colspan="3">Comment: {{ entry.comment }}</td>
                    <td>
                        {% if current_user.username == username %}
                        <form action="{{ url_for('main.delete_entry') }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this entry?');">
                            {{ delete_entry_forms[entry.id].hidden_tag() }}
                            {{ delete_entry_forms[entry.id].entry_id() }}
                            {{ delete_entry_forms[entry.id].submit(class="btn btn-danger btn-sm") }}
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if total_pages > 1 %}
            <nav aria-label="Pagination">
            <ul class="pagination justify-content-center mt-4">
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link"
                    href="{{ url_for(request.endpoint, page=page-1, **request_args) }}">
                    &laquo; Prev
                    </a>
                </li>
                {% endif %}
                {% for p in range(1, total_pages+1) %}
                <li class="page-item {% if p==page %}active{% endif %}">
                    <a class="page-link"
                    href="{{ url_for(request.endpoint, page=p, **request_args) }}">
                    {{ p }}
                    </a>
                </li>
                {% endfor %}
                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link"
                    href="{{ url_for(request.endpoint, page=page+1, **request_args) }}">
                    Next &raquo;
                    </a>
                </li>
                {% endif %}
            </ul>
            </nav>
            {% endif %}
    </section>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Ensure all comment rows are hidden by default
        document.querySelectorAll('.entry-comment').forEach(commentRow => {
            commentRow.style.display = 'none';
        });

        // Toggle visibility of the comment section when an entry row is clicked
        document.querySelectorAll('.entry-row').forEach(row => {
            row.addEventListener('click', () => {
                const commentRow = row.nextElementSibling;
                if (commentRow && commentRow.classList.contains('entry-comment')) {
                    commentRow.style.display = commentRow.style.display === 'table-row' ? 'none' : 'table-row';
                }
            });
        });
    });
</script>

{% endblock %}